# IPTV 电视端播放器开发文档

## 1. 项目概述

### 1.1 项目背景
本项目旨在开发一款运行于智能电视 / Android TV / 机顶盒（STB）的 IPTV 播放器应用，支持直播频道播放、节目单（EPG）、收藏、频道切换、基础设置等核心功能，强调 **遥控器友好交互**、**高性能播放** 与 **简洁大屏 UI 体验**。

### 1.2 目标用户
- 使用智能电视或机顶盒的普通家庭用户
- 需要观看 IPTV 直播源的用户
- 偏好“即开即看”、操作简单的电视端用户

### 1.3 设计目标
- 单手遥控器即可完成 95% 操作
- 播放稳定、切换频道迅速
- UI 大字号、高对比，适合 2–5 米观看距离
- 可扩展（多源、多语言、多地区）

---

## 2. 技术选型

### 2.1 平台
- Android TV
- Android 机顶盒（兼容）

### 2.2 开发技术
- UI：**Jetpack Compose for TV（官方组件优先）**
- 架构：MVVM + StateFlow
- 播放器内核：ExoPlayer

### 2.3 官方组件优先原则（重要）

> 在满足需求的前提下，**优先使用 Jetpack Compose / Compose for TV 官方组件**，避免不必要的自定义组件，以保证：

- 更好的流畅性与渲染性能
- 与系统遥控器焦点系统的天然兼容
- 更稳定的一致性操作体验

#### 使用策略
- 优先使用：
  - `TvLazyColumn` / `TvLazyRow`
  - `NavigationDrawer`
  - `Surface`
  - `Text` / `Image`
- 仅在以下情况下才自定义组件：
  - 官方组件无法满足电视端交互需求
  - 需要特定视觉效果且不影响焦点逻辑

#### 焦点与性能约束
- 不重写官方焦点行为
- 不在列表项中嵌套复杂自定义绘制
- 避免不必要的 `Canvas` 与 `Modifier.draw*`

---

## 3. 功能模块设计

### 3.1 核心功能列表

| 模块 | 功能说明 |
|----|----|
| 播放 | 直播流播放、缓冲、错误重试 |
| 频道 | 频道列表、分类、快速切换 |
| EPG | 节目单查看、当前节目 |
| 收藏 | 频道收藏 / 取消收藏、收藏分组 |
| 设置 | 播放设置、源与 EPG 配置 |

----|----|
| 播放 | 直播流播放、缓冲、错误重试 |
| 频道 | 频道列表、分类、切换 |
| EPG | 节目单查看、当前节目 |
| 收藏 | 收藏频道、快速访问 |
| 设置 | 播放设置、源管理 |

---

## 4. UI 结构设计（信息架构）

```
启动页
  └── 首次配置页（仅首次 / 未配置）
        └── 播放页（主界面）
              ├── 左侧频道抽屉（左键呼出）
              │     ├── 分类列表
              │     ├── 频道列表（默认焦点）
              │     └── 节目列表（EPG）
              ├── 播放控制浮层
              └── 设置页（全屏）
```

---

## 5. 关键页面 UI 与交互设计

### 5.1 启动页（Splash）

- 显示 Logo（1–2 秒）
- 初始化播放内核
- 检查 IPTV 源 & EPG 配置状态

流程逻辑：
- **未配置源 / EPG** → 进入首次配置页
- **已配置** → 直接进入播放页并自动播放上次频道

---

### 5.2 播放页（主界面）

#### UI 构成
- 全屏视频画面（默认）
- 无常驻控件（极简）

#### 遥控器交互（最小操作原则）

| 按键 | 行为 |
|----|----|
| ← | 打开左侧频道菜单抽屉 |
| OK | 打开频道信息浮层 |
| ↑ | 切换上一个频道（立即播放） |
| ↓ | 切换下一个频道（立即播放） |
| → | 收藏 / 取消收藏当前频道 |
| Back | 关闭浮层 / 退出应用 |

设计说明：
- 上下键为**全局频道切换行为**，不依赖焦点
- 右键为**轻量级瞬时操作**，不打断播放

----|----|
| ← | 打开左侧频道菜单抽屉 |
| OK | 打开频道信息浮层 |
| ↑ | 切换上一个频道（立即播放） |
| ↓ | 切换下一个频道（立即播放） |
| → | 预留（暂不实现） |
| Back | 关闭浮层 / 退出应用 |

设计说明：
- 所有高频操作均可在 **不进入菜单** 的情况下完成
- 频道切换不依赖焦点，符合传统电视习惯

----|----|
| ← | 打开频道菜单抽屉 |
| OK | 呼出播放信息浮层 |
| → | 切换下一个频道 |
| ↑ | 切换上一个频道 |
| Back | 关闭浮层 / 退出应用 |

----|----|
| OK | 呼出播放控制浮层 |
| ↑ | 呼出频道列表 |
| ↓ | 呼出节目单 |
| ← / → | 切换上/下一个频道 |
| Back | 关闭浮层 / 退出应用 |

---

### 5.3 频道信息浮层（OK 键）

> 用于快速查看当前直播信息，不打断观看流程。

#### UI 位置
- 底部浮层（不遮挡核心画面）

#### 显示信息
- 频道名称
- 当前节目名称
- 直播码流（kbps / Mbps）
- 分辨率（如 1920×1080）
- 帧率（FPS）

#### 交互规则
- OK 键呼出
- 5 秒无操作自动隐藏
- 不可获取焦点，仅展示
- 右键收藏操作后可在此浮层短暂提示状态变化

---

### 5.4 左侧频道菜单抽屉（核心交互）

> 通过 **左键（←）** 呼出，仅在需要“找频道 / 看节目单”时使用。

#### UI 布局（从左到右）

| 区域 | 说明 | 宽度建议 |
|----|----|----|
| 分类列表 | 频道分类（包含 ⭐ 我的收藏） | 20% |
| 频道列表 | 当前分类下频道（默认焦点） | 40% |
| 节目列表 | 当前频道节目单（EPG） | 40% |

#### 收藏分类说明
- ⭐ 我的收藏 固定为第一个分类
- 自动包含所有已收藏频道

#### 默认焦点
- 打开抽屉时，**焦点始终落在频道列表当前播放频道**

#### 焦点流转规则
- 左右：分类 ⇄ 频道列表 ⇄ 节目列表
- 上下：当前列内部移动

#### 交互行为

| 区域 | OK 行为 |
|----|----|
| 分类 | 切换分类并刷新频道列表 |
| 频道 | 切换频道并立即播放 |
| 节目 | 仅查看，不触发播放 |

| 其他 | 行为 |
|----|----|
| Back | 关闭抽屉并回到全屏播放 |

----|----|----|
| 分类列表 | 频道分类 | 20% |
| 频道列表 | 当前分类下频道（默认焦点） | 40% |
| 节目列表 | 当前频道节目单（EPG） | 40% |

#### 默认焦点
- 打开抽屉时，**焦点始终落在频道列表当前播放频道**

#### 焦点流转规则
- 左右：分类 ⇄ 频道列表 ⇄ 节目列表
- 上下：当前列内部移动

#### 交互行为

| 区域 | OK 行为 |
|----|----|
| 分类 | 切换分类并刷新频道列表 |
| 频道 | 切换频道并立即播放 |
| 节目 | 仅查看，不触发播放 |

| 其他 | 行为 |
|----|----|
| Back | 关闭抽屉并回到全屏播放 |

----|----|----|
| 分类列表 | 频道分类（新闻 / 体育 / 娱乐 等） | 20% |
| 频道列表 | 当前分类下频道 | 40% |
| 节目列表 | 当前频道 EPG | 40% |

#### 默认焦点
- **首次打开抽屉，默认焦点在「频道列表」当前播放频道**

#### 焦点流转规则

- 左右：
  - 分类 ⇄ 频道列表 ⇄ 节目列表
- 上下：
  - 当前区域内移动

#### 交互行为

| 操作 | 行为 |
|----|----|
| OK（频道） | 切换并立即播放 |
| OK（分类） | 刷新频道列表 |
| OK（节目） | 仅查看（直播不可点播） |
| Back | 关闭抽屉并回到播放 |

----|----|
| ↑ ↓ | 切换频道焦点 |
| OK | 切换并播放频道 |
| Back | 收起侧边栏 |

---

### 5.5 节目单（EPG）浮层

#### UI
- 底部浮层（40% 高度）
- 时间轴 + 节目列表

#### 功能
- 显示当前 / 下一个节目
- 高亮正在播放节目

#### 交互
- 左右：切换日期 / 时间
- 上下：切换节目

---

### 5.6 首次配置页（关键页面）

> 仅在 **首次启动或未完成配置** 时出现，目标是 **一次配置，永久使用**。

#### 配置项
- IPTV 播放源地址（m3u / txt）
- EPG 地址（xml / xml.gz）

#### UI 原则
- 表单居中
- 大字号
- 明确引导文案

#### 交互流程

```
输入源地址 → 校验成功 → 输入 EPG → 校验成功 → 保存 → 进入直播
```

- 支持遥控器输入 / 粘贴
- 校验失败给出明确提示

---

## 6. 频道源与数据结构设计

### 6.1 m3u 解析示例

字段说明：
- tvg-id
- tvg-name
- tvg-logo
- group-title
- url

### 6.2 内部数据模型

- Channel
  - id
  - name
  - logo
  - group
  - streamUrl

- Program
  - title
  - startTime
  - endTime

---

## 7. 播放器逻辑设计

### 7.1 播放流程

```
选择频道 → 校验 URL → 初始化 Player → prepare → play
            ↓失败
         自动切换备用源
```

### 7.2 异常处理
- 播放失败自动重试（2–3 次）
- 超时提示并切换频道
- 网络断开提示

---

## 8. 遥控器焦点与可用性设计

### 8.1 焦点基本原则

- 所有可操作元素必须可获取焦点
- 焦点态清晰可感知（放大 / 高亮 / 描边）
- 禁止出现焦点丢失或焦点陷阱

### 8.2 焦点状态持久化（重要）

> **所有关键交互区域的焦点状态必须被记忆与恢复**，以符合电视端用户的连续操作习惯。

#### 核心规则
- 焦点不是临时状态，而是用户操作上下文的一部分
- 页面切换、抽屉开关、浮层显示/隐藏后，应尽量恢复上一次焦点位置

#### 示例说明
- 用户按 ← 打开频道抽屉
- 在频道列表中选择并播放某频道
- 关闭抽屉
- **再次打开抽屉时，焦点应仍停留在该频道上**

#### 适用范围（不限于）
- 频道分类列表
- 频道列表
- 节目单列表（EPG）
- 设置页选项列表

#### 实现建议（Compose）
- 使用 `rememberSaveable` 记录索引或唯一 ID
- 使用 `FocusRequester` 在 UI 重新显示时主动恢复焦点
- 避免依赖系统默认焦点回溯行为

---

## 9. 性能与体验优化

- 切台时间 < 1.5 秒
- 列表懒加载
- EPG 数据本地缓存
- 播放页 GPU Overdraw 控制

---

## 10. 扩展规划

- 回看 / 时移
---
